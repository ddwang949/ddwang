---
description: 之前写的，从微步搬回到新的page上先
---

# Cacti CVE-2022-46169 远程命令执行漏洞分析

#### 漏洞编号

CVE-2022-46169

#### 影响范围

| 漏洞编号           | 影响厂商                | 产品    |
| -------------- | ------------------- | ----- |
| CVE-2022-46169 | The Cacti Group Inc | Cacti |

### 漏洞分析

### **CVE-2022-46169**

CVE-2022-46169漏洞利用包含两部分

1.身份认证绕过

2.远程命令执行

#### **漏洞分析**

1. **身份认证绕过分析**

由CVE描述可知，产生漏洞的文件为remote\_agent.php，

默认直接访问会显示报错信息FATAL: You are not authorized to use this service

查找到报错信息提示的代码处：

```
if (!remote_client_authorized()) {
    print 'FATAL: You are not authorized to use this service';
    exit;
}
```

因此身份认证绕过实际上则是需要绕过函数remote\_client\_authorized()的判断，函数remote\_client\_authorized()的实现如下：

![image](https://github.com/user-attachments/assets/b7beb380-2370-4741-a401-448d50fd7870)

remote\_client\_authorized()函数首先调用get\_client\_addr()函数，此函数在lib/functions.php中调用

![image](https://github.com/user-attachments/assets/7cc2d84e-c56e-4f71-b745-656ab88f301a)

因此需要在HTTP请求头中添加源码中之一的header条目，并将其值设置为合法的白名单IP地址即可通过身份认证，IP地址可以通过暴力破解获取。

2. **命令执行分析**

由补丁差异可知remote\_agent.php主要将$poller\_id和$networkid进行了过滤和转义。

![image](https://github.com/user-attachments/assets/a510bd83-199d-4a6a-b463-3ec9ab10066e)

![image](https://github.com/user-attachments/assets/577eaebc-4851-4aba-87a9-7722966bcc55)

![image](https://github.com/user-attachments/assets/dc1066b4-76f8-494d-a8a3-eb9acddcb5d7)

分析源代码可知，poller_id的调用主要在poll_for_data()函数中，执行流程如下

![image](https://github.com/user-attachments/assets/7c750dcd-a615-4ab3-8346-7789a7a2eec5)

![image](https://github.com/user-attachments/assets/034cb2a3-579c-4254-9dd7-b07651245f8a)

![image](https://github.com/user-attachments/assets/5da2cc70-1a8b-4c0e-9639-56723070ad7f)

poll_for_data()函数从请求中获取poller_id，并在未经过滤和转义的情况下直接拼接入$cactiphp语句中，最后执行，因此可以导致命令注入。

根据CVE描述，poll_for_data()函数中的local_data_ids和host_id两个参数也均可通过暴力破解获取正确的值

而poll_for_data()函数在remote_agent.php中作为可选动作，在传入action=polldata时会被执行

![image](https://github.com/user-attachments/assets/7b7a177d-a637-43ea-acae-ee3228495809)

#### 总结

因此，POC应当包含以下特征：

请求头中：HTTP_FORWARDED_FOR: {白名单IP}    //(或另外几请求头)

同时action=polldata     poller_id为命令注入点

#### 漏洞复现

复现描述：

POC:

GET /remote_agent.php?action=polldata&local_data_ids[0]=1&host_id=1&poller_id=`whoami>1.txt`  

HTTP_FORWARDED_FOR: x.x.x.x(白名单IP)

#### 参考链接
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-46169
