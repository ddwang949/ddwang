---
description: 之前写的，从微步搬回到新的page上先
---

# OpenSSL CVE-2022-3786 缓冲区溢出漏洞分析

### 漏洞编号

CVE-2022-3786

### 影响范围

| 漏洞编号          | 影响厂商           | 产品      |
| ------------- | -------------- | ------- |
| CVE-2022-3786 | Joyent         | Node.js |
|               | OpenSSL        | Openssl |
|               | Fedora Project | Fedora  |

### 漏洞分析

#### 漏洞编号

CVE-2022-3786

#### 影响产品

OpenSSL 3.0.x

X.509 certificate verification功能

#### 漏洞描述

攻击者可以不断添加以“xn--”开头的subdomain来编造一个恶意的电子邮件地址，最终利用此漏洞导致栈溢出。

#### 漏洞定位

crypto/x509/v3_ncons.c 中定义了 nc_email_eai()函数，用于处理和转换电子邮件域名

其中调用了ossl_a2ulabel()函数，此函数在crypto/punycode.c中定义，主要处理punycode编码的域名，punycode编码以xn--开头

#### POC：

任意字符*253 .xn--.xn--.xn--.xn--.xn--.xn--.xn--

会被解析为

任意字符*253 . ......

即每个xn--.会变成一个.

#### 漏洞分析

**原理分析：**

在处理Name Constraints扩展中的字符串时，会执行函数ossl_a2ulabel()函数会对域名进行解析，取出每两个 “.” 之间的部分，并且检测是否为xn--code开头，若不是则直接拷贝，若是则进行punycode解码后写入字符串中，并在字符串后面写入一个 "." 

此函数在直接拷贝原始字符和写入解码后的字符时都进行了长度验证，但并没有在写入"."前校验缓冲区长度，因此攻击者可以构造包含大量"xn--."的域名来导致数组写入越界，最终导致缓冲区溢出

源码分析：

![image](https://github.com/user-attachments/assets/7a6fdb75-29e4-4b74-9f6a-c32603227dc0)

![image](https://github.com/user-attachments/assets/87876b74-bb8a-471c-966a-e0819c0e609d)

![image](https://github.com/user-attachments/assets/8d10944f-5eb1-4a11-99c7-b77cd781aaad)

![image](https://github.com/user-attachments/assets/77c976c9-91a0-4d33-a3c0-b4d05fdfa78b)

![image](https://github.com/user-attachments/assets/1d9a7688-8d8e-4271-8992-7f00701abb50)


#### 参考链接

https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-3786


